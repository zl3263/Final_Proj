---
title: "Untitled"
author: "qz2492"
date: "2022-12-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(glmnet)
library(patchwork)
```


```{r}
load('./data/cleaned_data.RData')



data_1 = transformed_rental_income %>%
  separate(boro_block_lot, into = c("borough", "block", "lot"), sep = "-") %>%
  separate(building_classification, into = c("code", "type", "type_1"), sep = "-") %>%
  mutate(borough = factor(borough),
         neighborhood = factor(neighborhood),
         type = factor(type)) 
  


# make density plots of every variable to check its normality

p1 = data_1 %>%
  ggplot(aes(x = latitude)) +
  geom_density(aes(y = after_stat(density)),
                 fill = "#F0E442",
                 alpha = 0.75,
                 bins = 10)

p2 = data_1 %>%
  ggplot(aes(x = longitude)) +
  geom_density(aes(y = after_stat(density)),
                 fill = "#0072B2",
                 alpha = 0.75,
                 bins = 10)

# Logarithmic operation
p3 = data_1 %>%
  ggplot(aes(x = log(total_units))) +
  geom_density(aes(y = after_stat(density)),
                 fill = "#CC79A7",
                 alpha = 0.75,
                 bins = 10)

p4 = data_1 %>%
  ggplot(aes(x = year_built)) +
  geom_density(aes(y = after_stat(density)),
                 fill = "#D55E00",
                 alpha = 0.75,
                 bins = 10)
# Logarithmic operation
p5 = data_1 %>%
  ggplot(aes(x = log(gross_sq_ft))) +
  geom_density(aes(y = after_stat(density)),
                 fill = "#56B4E9",
                 alpha = 0.75,
                 bins = 10)
# Logarithmic operation
p6 = data_1 %>%
  ggplot(aes(x = log(estimated_gross_income))) +
  geom_density(aes(y = after_stat(density)),
                 fill = "#009E73",
                 alpha = 0.75,
                 bins = 10)


p1 + p2 + p3 + p4 + p5 + p6 

```



```{r}
#### log_estimated_gross_income

data_egi = data_1 %>%
  mutate(
    log_total_units = log(total_units),
    log_gross_sq_ft = log(gross_sq_ft),
    log_estimated_gross_income = log(estimated_gross_income)
  ) 

# intercept only model
io_eg = lm(log_estimated_gross_income ~ 1, data = data_egi)

# model with all predictors
all_eg = lm(log_estimated_gross_income ~  type
     + borough + log_total_units + year_built + log_gross_sq_ft, data = data_egi)

# stepwise procedure
egi_fit = step(io_eg, direction = "both", scope = formula(all_eg), trace = 0)

```

```{r}
# formula
equatiomatic::extract_eq(egi_fit, use_coefs = TRUE)
```

```{r}
summary(egi_fit)
```

```{r}
# check the model
performance::check_model(egi_fit)
```

```{r}
## estimated_gross_income

data_egi_nl = data_1 %>%
  mutate(
    log_total_units = log(total_units),
    log_gross_sq_ft = log(gross_sq_ft),
    log_estimated_gross_income = log(estimated_gross_income)
  ) 

# intercept only model
io_eg_nl = lm(estimated_gross_income ~ 1, data = data_egi_nl)

# model with all predictors
all_eg_nl =  lm(estimated_gross_income ~  type
     + borough + log_total_units + year_built + log_gross_sq_ft, data = data_egi_nl)

# stepwise procedure
egi_fit_nl = step(io_eg_nl, direction = "both", scope = formula(all_eg_nl), trace = 0)
```

```{r}
# formula
equatiomatic::extract_eq(egi_fit_nl, use_coefs = TRUE)
```

```{r}
summary(egi_fit_nl)
```

```{r}
# check the model
performance::check_model(egi_fit_nl)
```


```{r}
pred_df = data_egi_nl %>%
  modelr::add_predictions(model = egi_fit_nl) 

latitude = pred_df$latitude

longitude = pred_df$longitude

pred_Y = pred_df$pred

loess_val = loess(pred_Y ~ latitude + longitude)

loess_val
```









